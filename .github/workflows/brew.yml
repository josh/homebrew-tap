name: Homebrew

on: [push]

jobs:
  audit:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2

      - name: Install Homebrew bundler gems
        run: brew --env
        env:
          HOMEBREW_INSTALL_BUNDLER_GEMS_FIRST: 1

      - name: Audit formulas
        run: |
          brew audit --strict --online ./brew-unattended-upgrade.rb
          brew audit --strict --online ./csv2json.rb
          brew audit --strict --online ./displayrcd.rb
          brew audit --strict --online ./icloud-backup-utils.rb
          brew audit --strict --online ./sort-lines.rb
          brew audit --strict --online ./swift-completions.rb

  bump:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2

      - name: Update Homebrew
        run: brew update

      - name: Install Homebrew livecheck
        run: brew tap homebrew/livecheck

      - name: Check if formulas are outdated
        run: brew livecheck
        env:
          HOMEBREW_LIVECHECK_WATCHLIST: brew_livecheck_watchlist

      - name: Update outdated formulas
        run: script/bump-outdated-formula

      - name: Commit formula changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'joshbot@users.noreply.github.com'
          git add *.rb
          git commit --message "Update formulas" || true

      - name: Push changes
        run: git push
